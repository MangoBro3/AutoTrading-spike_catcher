<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto Trading Cockpit</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0f1115;color:#e9edf1;margin:0;padding:16px}
    h1{margin:0;font-size:22px} h2{margin:0 0 10px;font-size:17px}
    .muted{color:#9aa4b2;font-size:12px}.ok{color:#47d16c}.warn{color:#ffca5f}.bad{color:#ff6b6b}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;margin-top:12px}
    .card{background:#161a22;border:1px solid #252b36;border-radius:10px;padding:12px}
    .banner{display:none;margin:12px 0 0;padding:10px 12px;border-radius:8px;font-weight:700}
    .zone1{width:100%;margin:10px 0 12px;padding:12px 14px;border-radius:10px;font-weight:800;text-align:center}
    .zone1.live{background:#b91c1c;color:#fff;border:1px solid #ef4444}
    .zone1.paper{background:#166534;color:#dcfce7;border:1px solid #22c55e}
    .traffic-fixed{position:fixed;top:10px;right:12px;z-index:100;font-weight:900;padding:6px 10px;border-radius:999px;background:#111827;border:1px solid #374151}
    .debug-raw{display:none !important}
    .zone2-top{max-width:1100px;margin:0 auto 12px}
    .zone3-panel{border:1px solid #334155;border-radius:10px;padding:10px;background:#111827}
    .advanced{margin-top:12px}
    .banner.show{display:block}.banner.danger{background:#4a1318;border:1px solid #a8323d;color:#ffd7dc}
    .btn{background:#243047;border:1px solid #33425f;color:#e9edf1;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}.btn-danger{background:#4a1f24;border-color:#7a2f39;color:#ffd7dc}
    .btn-selected{background:#2e6f43;border-color:#3a8854}
    .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px}
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid #5d6a81;border-top-color:#e9edf1;border-radius:50%;animation:spin .7s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    input[type="text"]{flex:1;background:#111722;border:1px solid #2a3342;color:#e9edf1;border-radius:6px;padding:6px}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:7px;border-bottom:1px solid #262d38;text-align:left;vertical-align:top}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent}
    .pill-stop{background:#3a2024;color:#ffb7c0;border-color:#6f303a}.pill-wait{background:#3d3320;color:#ffd98e;border-color:#72603b}.pill-run{background:#1f3a2a;color:#9ff1bc;border-color:#356a4a}
    .switch-wrap{display:flex;align-items:center;gap:10px;margin:8px 0}.switch{position:relative;display:inline-block;width:52px;height:30px}
    .switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;inset:0;background:#394253;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background:#2e6f43} input:checked + .slider:before{transform:translateX(22px)} input:disabled + .slider{opacity:.5;cursor:not-allowed}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}.modal.show{display:flex}
    .modal-card{width:min(460px,92vw);background:#161a22;border:1px solid #2f3745;border-radius:10px;padding:14px}.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}.review-list{max-height:240px;overflow:auto;border:1px solid #262d38;border-radius:8px}.review-list table{font-size:12px}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .kv{display:flex;gap:14px;flex-wrap:wrap;margin:8px 0 10px}.kv b{font-size:14px}
    #capitalChart{width:100%;height:260px;background:#0f141d;border:1px solid #2a3140;border-radius:8px}
    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px}
    .kpi-card{background:#141924;border:1px solid #2b3343;border-radius:10px;padding:10px}
    .kpi-title{font-size:12px;color:#9aa4b2}
    .kpi-main{font-size:16px;font-weight:700;margin-top:4px}
  </style>
</head>
<body>
  <h1>Auto Trading Cockpit</h1>
  <div class="muted" id="ts">loading...</div>
  <div id="trafficFixed" class="traffic-fixed">â— --</div>
  <div id="modeTopBanner" class="zone1 paper">PAPER</div>
  <div class="inline debug-raw" style="margin-top:6px"><span id="truthBadge" class="pill pill-stop">TRUTH=-</span><span id="truthSource" class="muted"></span></div>
  <div class="inline"><button id="refreshConnBtn" class="btn">ì—°ê²° ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button><span id="refreshConnState" class="muted">ìˆ˜ë™ ê°±ì‹ : -</span></div>
  <div id="stopBanner" class="banner danger"></div>
  <div id="blockedBanner" class="banner danger"></div>
  <div id="runtimeStatusBanner" class="banner danger"></div>
  <div class="inline" id="nextActionWrap" style="display:none"><button id="nextActionBtn" class="btn btn-danger">ë‹¤ìŒ ì•¡ì…˜ ì‹¤í–‰</button><span id="nextActionHint" class="muted"></span></div>
  <div id="marketOneLiner" class="banner" style="display:none;background:#1e3a27;border:1px solid #3f7a58;color:#d7ffe6"></div>

  <div class="zone2-top"><div class="card"><h2>ê³„ì¢Œ / í¬ì§€ì…˜ / PnL</h2><div id="account"></div><div id="positions" style="margin-top:10px"></div></div></div>

  <div class="kpi-row">
    <div class="kpi-card"><div class="kpi-title">ê°€ìš©ìê¸ˆ TOTAL</div><div class="kpi-main" id="fundTotalEquity">-</div><div class="muted">available: <span id="fundTotalAvail">-</span> | ì „ì¼ëŒ€ë¹„: <span id="fundTotalDelta">-</span></div></div>
    <div class="kpi-card"><div class="kpi-title">ê°€ìš©ìê¸ˆ UPBIT</div><div class="kpi-main" id="fundUpbitEquity">-</div><div class="muted">available: <span id="fundUpbitAvail">-</span> | ì „ì¼ëŒ€ë¹„: <span id="fundUpbitDelta">-</span></div></div>
    <div class="kpi-card"><div class="kpi-title">ê°€ìš©ìê¸ˆ BITHUMB</div><div class="kpi-main" id="fundBithumbEquity">-</div><div class="muted">available: <span id="fundBithumbAvail">-</span> | ì „ì¼ëŒ€ë¹„: <span id="fundBithumbDelta">-</span></div></div>
  </div>

  <div class="grid">
    <div class="card zone3-panel">
      <h2>ìš´ì˜ ì œì–´ íŒ¨ë„</h2>
      <div class="muted">LIVE ì „í™˜ì€ 2ë‹¨ í™•ì¸ í•„ìˆ˜</div>
      <div class="inline">
        <button id="modePaperBtn" class="btn">PAPER</button>
        <button id="modeLiveBtn" class="btn btn-danger">LIVE</button>
      </div>
      <div class="inline" style="margin-top:8px">
        <button id="runBtn" class="btn">RUN</button>
        <button id="pauseBtn" class="btn">PAUSE</button>
        <button id="stopBtn" class="btn btn-danger">STOP</button>
        <button id="panicInlineBtn" class="btn btn-danger">HOLD TO PANIC</button>
      </div>
      <div id="modeStatus" class="muted" style="margin-top:8px"></div>
      <div class="inline" style="margin-top:8px"><button id="modeConfirmBtn" class="btn btn-danger" style="display:none">LIVE ì „í™˜ Confirm</button><span id="modeConfirmHint" class="muted"></span></div>
      <div style="margin-top:10px">
        <div class="muted">ê±°ë˜ì†Œ í™œì„±í™”</div>
        <div class="switch-wrap" style="margin-top:6px">
          <label class="switch"><input id="upbitToggle" type="checkbox" checked /><span class="slider"></span></label>
          <span style="min-width:58px">Upbit</span>
          <span id="upbitToggleLabel" class="muted">í™œì„±</span>
        </div>
        <div class="switch-wrap">
          <label class="switch"><input id="bithumbToggle" type="checkbox" checked /><span class="slider"></span></label>
          <span style="min-width:58px">Bithumb</span>
          <span id="bithumbToggleLabel" class="muted">í™œì„±</span>
        </div>
        <div id="exchangeToggleStatus" class="muted">ê±°ë˜ì†Œ í† ê¸€ ëŒ€ê¸°ì¤‘</div>
      </div>
    </div>

    <div class="card" style="display:none">
      <h2>Auto Trading ON/OFF</h2>
      <div style="margin-top:8px">í˜„ì¬ ìƒíƒœ: <span id="controlPhaseBadge" class="pill pill-stop">STOPPED</span></div>
      <div class="switch-wrap">
        <label class="switch"><input id="autoToggle" type="checkbox" /><span class="slider"></span></label>
        <span id="autoToggleLabel" style="font-weight:700">OFF</span>
      </div>
      <div id="controlStatus" class="muted">ëŒ€ê¸°ì¤‘</div>
      <div style="margin-top:10px;padding:8px;border:1px solid #7a2f39;border-radius:8px;background:#2a171b">
        <div style="font-weight:700;color:#ffd7dc">âš  Lock ê°•ì œí•´ì œ (Force Unlock)</div>
        <div class="muted" style="margin-top:4px">stale lock ì˜ì‹¬ ìƒí™©ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ê°•ì œí•´ì œ í›„ ì¦‰ì‹œ Start ì¬ì‹œë„ ê°€ëŠ¥í•˜ë©°, ì˜ëª» ì‚¬ìš©í•˜ë©´ ì¤‘ë³µ ì‹¤í–‰ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.</div>
        <div class="inline" style="margin-top:8px"><button id="forceUnlockBtn" class="btn btn-danger">Lock ê°•ì œí•´ì œ</button></div>
      </div>
    </div>

    <div class="card">
      <h2>ì—°ê²° ì¸ë””ì¼€ì´í„°</h2>
      <div id="connIndicators"></div>
    </div>

    <div class="card">
      <h2>Watching ì¢…ëª©</h2>
      <div id="watchingList" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="card">
      <h2>Settings</h2>
      <div class="muted">total/upbit/bithumb cap (KRW, 0=ë¬´ì œí•œ)</div>
      <div class="inline" style="margin-top:8px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="totalCapInput" style="min-width:90px">total_cap_krw</label>
        <input id="totalCapInput" type="text" placeholder="ì˜ˆ: 1000000" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="upbitCapInput" style="min-width:90px">upbit_cap_krw</label>
        <input id="upbitCapInput" type="text" placeholder="ì˜ˆ: 500000" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="bithumbCapInput" style="min-width:90px">bithumb_cap_krw</label>
        <input id="bithumbCapInput" type="text" placeholder="ì˜ˆ: 500000" />
      </div>
      <div class="inline" style="margin-top:8px">
        <button id="capitalCapSaveBtn" class="btn">ì €ì¥</button>
      </div>
      <div id="capitalCapStatus" class="muted" style="margin-top:8px">ëŒ€ê¸°ì¤‘</div>
    </div>


    <div class="card">
      <h2>ì–´ì œì˜ íŠ¸ë ˆì´ë”© ë¦¬ë·° (ìµœê·¼ 7ì¼)</h2>
      <div id="virtualCapitalMeta" class="muted">ê°€ìš©ìê¸ˆ ê·œì¹™: í˜„ì¬ virtual_equity = ë‹¤ìŒ ê°€ìš©ìê¸ˆ</div>
      <div class="review-list" style="margin-top:8px">
        <table>
          <thead><tr><th>Date</th><th>PnL</th><th>Virtual Equity</th><th>Trades</th><th>Source</th></tr></thead>
          <tbody id="reviewTable"><tr><td colspan="5" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>ìš´ìš©ìê¸ˆ ì¼ì¼ ê·¸ë˜í”„ (ìµœê·¼ 30ì¼)</h2>
      <div class="inline" style="margin-bottom:6px">
        <button id="capitalViewTotal" class="btn btn-selected">ì „ì²´</button>
        <button id="capitalViewUpbit" class="btn">ì—…ë¹„íŠ¸</button>
        <button id="capitalViewBithumb" class="btn">ë¹—ì¸</button>
      </div>
      <div class="kv">
        <div>í˜„ì¬ìì‚° <b id="capitalCurrent">-</b></div>
        <div>ì „ì¼ëŒ€ë¹„ <b id="capitalDelta">-</b></div>
        <div>ì‹œì‘ìê¸ˆ ëŒ€ë¹„ ëˆ„ì ìˆ˜ìµë¥  <b id="capitalCumRet">-</b></div>
      </div>
      <canvas id="capitalChart" width="800" height="260"></canvas>
      <div id="capitalFallback" class="muted" style="margin-top:8px;display:none">ìš´ìš©ìê¸ˆ ì¼ë³„ ë°ì´í„°ê°€ ì—†ì–´ ê·¸ë˜í”„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (daily_virtual_snapshot / runtimeÂ·ledger fallback ì—†ìŒ)</div>
      <div id="capitalSource" class="muted" style="margin-top:6px">source: -</div>
    </div>

    <div class="card" style="display:none">
      <h2>Panic ì•ˆì „ì¥ì¹˜</h2>
      <div class="muted">1) ìŠ¬ë¼ì´ë”ë¥¼ 100ìœ¼ë¡œ ì´ë™ 2) HOLD 2ì´ˆ ìœ ì§€</div>
      <div style="margin-top:8px"><input id="panicSlider" type="range" min="0" max="100" step="1" value="0" style="width:100%" /><div class="muted">value: <span id="panicValue">0</span></div></div>
      <button id="panicHoldBtn" class="btn" style="margin-top:8px">HOLD TO PANIC</button>
      <div id="panicStatus" class="muted" style="margin-top:8px">ëŒ€ê¸°ì¤‘</div>
    </div>

    <div class="card">
      <h2>Orders ì·¨ì†Œ</h2>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="orderIdInput" type="text" placeholder="ORD-001" /><button id="orderCancelBtn" class="btn">Cancel Order</button></div>
      <div id="orderStatus" class="muted" style="margin-top:8px">ëŒ€ê¸°ì¤‘</div>
    </div>

    <details class="advanced"><summary>Advanced</summary><div class="card" id="manualRoundtripCard" style="margin-top:8px">
      <h2>Manual Roundtrip Test (1íšŒ ì™•ë³µ)</h2>
      <div class="inline" style="margin-top:8px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="manualRoundtripSymbol" style="min-width:120px">symbol</label>
        <input id="manualRoundtripSymbol" type="text" value="KRW-XRP" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="manualRoundtripNotional" style="min-width:120px">notional</label>
        <input id="manualRoundtripNotional" type="text" value="5500" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="manualRoundtripBuyOffsetTicks" style="min-width:120px">buy_offset_ticks</label>
        <input id="manualRoundtripBuyOffsetTicks" type="text" value="1" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="manualRoundtripHoldSeconds" style="min-width:120px">hold_seconds</label>
        <input id="manualRoundtripHoldSeconds" type="text" value="30" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="manualRoundtripBidMinusTicks" style="min-width:120px">bid_minus_ticks</label>
        <input id="manualRoundtripBidMinusTicks" type="text" value="0" />
      </div>
      <div class="inline" style="margin-top:6px;align-items:center;flex-wrap:wrap">
        <label class="muted" for="manualRoundtripConfirm" style="min-width:120px">confirm</label>
        <input id="manualRoundtripConfirm" type="text" placeholder="MANUAL ROUNDTRIP LIVE" />
      </div>
      <div class="inline" style="margin-top:8px">
        <button id="manualRoundtripRunBtn" class="btn">í…ŒìŠ¤íŠ¸ 1íšŒ ì™•ë³µì£¼ë¬¸ ì‹¤í–‰</button>
      </div>
      <div id="manualRoundtripState" class="muted" style="margin-top:8px">-</div>
      <pre id="manualRoundtripResult" class="muted" style="margin-top:8px;white-space:pre-wrap;background:#111722;border:1px solid #2a3342;border-radius:6px;padding:8px;max-height:180px;overflow:auto">-</pre>
    </div></details>
  </div>

<!-- zone2 moved to top -->

  <div id="confirmModal" class="modal"><div class="modal-card"><h2 style="margin-bottom:8px">í™•ì¸</h2><div id="confirmModalText" class="muted" style="font-size:13px"></div><div class="modal-actions"><button id="confirmModalCancel" class="btn">ì·¨ì†Œ</button><button id="confirmModalApprove" class="btn btn-danger">ìŠ¹ì¸</button></div></div></div>

<script>
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s??'').replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
const val = (obj, keys, fallback='-') => { for (const k of keys){const v=obj?.[k]; if(v!==undefined&&v!==null&&v!=='') return v;} return fallback; };
const fmtKrw = (v)=>{ const n=Number(v); return Number.isFinite(n) ? `${n.toLocaleString()} KRW` : '-'; };
const fmtPct = (v)=>{ const n=Number(v); return Number.isFinite(n) ? `${n>=0?'+':''}${n.toFixed(2)}%` : '-'; };

function normalizeMode(v){ const m=String(v||'').trim().toUpperCase(); return (m==='LIVE'||m==='PAPER')?m:''; }
function resolveDisplayMode(data){
  const truthMode = normalizeMode(data?.truth?.mode || data?.worker?.state?.truth?.mode);
  const topLevelMode = normalizeMode(data?.mode);
  const controllerMode = normalizeMode(data?.controller_mode);
  const mode = truthMode || topLevelMode || controllerMode || selectedMode || 'PAPER';
  const source = truthMode ? 'truth.mode' : (topLevelMode ? 'mode' : (controllerMode ? 'controller_mode' : 'selectedMode'));
  return { mode, source };
}

function setCapitalViewButtons(){
  $('capitalViewTotal')?.classList.toggle('btn-selected', capitalView==='total');
  $('capitalViewUpbit')?.classList.toggle('btn-selected', capitalView==='upbit');
  $('capitalViewBithumb')?.classList.toggle('btn-selected', capitalView==='bithumb');
}

function renderCapitalChart(graphPack){
  const graph = graphPack?.[capitalView] || graphPack?.total || graphPack || {};
  const rows = Array.isArray(graph?.rows) ? graph.rows : [];
  $('capitalSource').textContent = `view: ${capitalView} | source: ${graph?.source || '-'}`;
  $('capitalCurrent').textContent = fmtKrw(graph?.current_equity);
  const dKrw = Number(graph?.day_delta_krw), dPct = Number(graph?.day_delta_pct);
  $('capitalDelta').textContent = Number.isFinite(dKrw) ? `${dKrw>=0?'+':''}${dKrw.toLocaleString()} KRW (${fmtPct(dPct)})` : '-';
  $('capitalCumRet').textContent = fmtPct(graph?.cumulative_return_pct);

  const canvas = $('capitalChart');
  const fallback = $('capitalFallback');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  if (!rows.length){
    const label = capitalView==='upbit' ? 'ì—…ë¹„íŠ¸' : (capitalView==='bithumb' ? 'ë¹—ì¸' : 'ì „ì²´');
    fallback.textContent = `${label} ìš´ìš©ìê¸ˆ ì¼ë³„ ë°ì´í„°ê°€ ì—†ì–´ ê·¸ë˜í”„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (daily_virtual_snapshot / runtimeÂ·ledger fallback ì—†ìŒ)`;
    fallback.style.display='block';
    return;
  }
  fallback.style.display='none';

  const pad = {l:40,r:12,t:16,b:22};
  const topH = Math.floor((H - pad.t - pad.b) * 0.62);
  const botY = pad.t + topH + 8;
  const botH = H - botY - pad.b;
  const xs = rows.map((_,i)=> pad.l + (i * (W - pad.l - pad.r) / Math.max(1, rows.length-1)));

  const equities = rows.map(r=>Number(r.virtual_equity)).filter(Number.isFinite);
  if (!equities.length){
    const label = capitalView==='upbit' ? 'ì—…ë¹„íŠ¸' : (capitalView==='bithumb' ? 'ë¹—ì¸' : 'ì „ì²´');
    fallback.textContent = `${label} equity ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ ê·¸ë˜í”„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
    fallback.style.display='block';
    return;
  }
  const eqMin = Math.min(...equities), eqMax = Math.max(...equities);
  const eqRange = Math.max(1, eqMax - eqMin);
  const ey = (v)=> pad.t + (topH - ((v - eqMin) / eqRange) * topH);

  const pnls = rows.map(r=>Number(r.pnl_krw)||0);
  const pnlMaxAbs = Math.max(1, ...pnls.map(v=>Math.abs(v)));
  const zeroY = botY + botH/2;

  ctx.strokeStyle='#2c3546'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad.l, zeroY); ctx.lineTo(W-pad.r, zeroY); ctx.stroke();

  for(let i=0;i<rows.length;i++){
    const x=xs[i], p=pnls[i];
    const h=Math.abs(p)/pnlMaxAbs*(botH/2-2);
    ctx.fillStyle = p>=0 ? '#29c173' : '#e05d6f';
    ctx.fillRect(x-4, p>=0?zeroY-h:zeroY, 8, h);
  }

  ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2;
  ctx.beginPath();
  rows.forEach((r,i)=>{ const y=ey(Number(r.virtual_equity)||eqMin); if(i===0) ctx.moveTo(xs[i],y); else ctx.lineTo(xs[i],y); });
  ctx.stroke();

  ctx.fillStyle='#9aa4b2'; ctx.font='11px system-ui';
  ctx.fillText(rows[0]?.date || '', pad.l, H-6);
  ctx.fillText(rows[rows.length-1]?.date || '', W-90, H-6);
}

let latestOverview=null, controlBusy=false, syncingToggle=false, syncingExchangeToggle=false;
let capitalView='total';
let manualRefreshBusy=false, lastManualRefreshAt=null, lastManualRefreshError='';
let selectedMode='PAPER';
let exchangeToggles={upbit:true,bithumb:true};
let pendingExpectedPhrase='';

function phaseFromOverview(data){ return String(data?.worker?.state?.phase || data?.worker?.phase || data?.phase || 'STOPPED').toUpperCase(); }
function isAutoOnByPhase(phase){ return phase==='RUNNING'||phase==='WAITING_OPERATOR'; }
function phaseBadgeClass(phase){ if(phase==='RUNNING') return 'pill pill-run'; if(phase==='WAITING_OPERATOR') return 'pill pill-wait'; return 'pill pill-stop'; }
function syncToggleUI(phase){ syncingToggle=true; const checked=isAutoOnByPhase(phase); $('autoToggle').checked=checked; $('autoToggle').disabled=controlBusy; $('autoToggleLabel').textContent=checked?'ON':'OFF'; const b=$('controlPhaseBadge'); b.className=phaseBadgeClass(phase); b.textContent=phase; syncingToggle=false; }
function setModeButtons(){ $('modePaperBtn').classList.toggle('btn-selected', selectedMode==='PAPER'); $('modeLiveBtn').classList.toggle('btn-selected', selectedMode==='LIVE'); $('modeStatus').textContent = `ì„ íƒ ëª¨ë“œ: ${selectedMode}`; }
function setModeConfirmUI(){ const btn=$('modeConfirmBtn'); const has=!!pendingExpectedPhrase; btn.style.display=has?'inline-block':'none'; btn.disabled=controlBusy||!has; $('modeConfirmHint').textContent=has?'expected_phrase ìˆ˜ì‹ ë¨. Confirm ë²„íŠ¼ìœ¼ë¡œ ìµœì¢… ìŠ¹ì¸í•˜ì„¸ìš”.':''; }
function setBlockedUI(data){ const banner=$('blockedBanner'); const wrap=$('nextActionWrap'); const why=String(data?.worker?.state?.why_blocked || data?.result?.why_blocked || data?.why_blocked || data?.worker?.state?.safe_start?.details?.message || '').trim(); const nextAction=String(data?.worker?.state?.next_action || data?.result?.next_action || data?.next_action || '').trim(); $('nextActionHint').textContent=nextAction?`next_action: ${nextAction}`:''; if(why){ banner.className='banner danger show'; banner.textContent=`BLOCKED: ${why}`; } else { banner.className='banner danger'; banner.textContent=''; }
  if(nextAction){ wrap.style.display='flex'; $('nextActionBtn').dataset.action=nextAction; } else { wrap.style.display='none'; $('nextActionBtn').dataset.action=''; }
}

function syncExchangeToggleUI(){
  syncingExchangeToggle=true;
  $('upbitToggle').checked=!!exchangeToggles.upbit;
  $('bithumbToggle').checked=!!exchangeToggles.bithumb;
  $('upbitToggleLabel').textContent=exchangeToggles.upbit?'í™œì„±':'ë¹„í™œì„±';
  $('bithumbToggleLabel').textContent=exchangeToggles.bithumb?'í™œì„±':'ë¹„í™œì„±';
  syncingExchangeToggle=false;
}
function pickStartExchange(){
  const runtimeExchange=String(latestOverview?.truth?.exchange || latestOverview?.runtimeStatus?.exchange || '').toUpperCase();
  if (runtimeExchange==='UPBIT' && exchangeToggles.upbit) return 'UPBIT';
  if (runtimeExchange==='BITHUMB' && exchangeToggles.bithumb) return 'BITHUMB';
  if (exchangeToggles.upbit) return 'UPBIT';
  if (exchangeToggles.bithumb) return 'BITHUMB';
  return null;
}

function overviewUrl(){ return '/api/overview'; }
async function fetchJson(url){ const r=await fetch(url); const j=await r.json(); if(!r.ok) throw new Error(`${url} ${r.status}`); return j; }
function toBlockedPayload(src){
  const why = String(src?.why_blocked || src?.details?.message || src?.detail || src?.error || '').trim();
  const next = String(src?.next_action || (src?.requires_operator_confirm ? 'confirm_start' : '') || '').trim();
  return { worker: { state: { why_blocked: why, next_action: next } } };
}

async function postControl(action, body){
  const r=await fetch(`/api/worker/control/${action}`, {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})});
  const j=await r.json();
  if(!r.ok||j.ok===false){
    const e = new Error(j?.error||`control_failed:${action}`);
    e.payload = j;
    throw e;
  }
  if(j?.result?.ok===false){
    const e = new Error(j?.result?.detail||j?.result?.error||`worker_control_failed:${action}`);
    e.payload = j;
    throw e;
  }
  return j;
}
async function postExchangeToggles(body){ const r=await fetch('/api/worker/control/exchanges', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||'control_failed:exchanges'); return j; }
async function postUiSettings(body){ const r=await fetch('/api/ui-settings', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||'save_failed:ui_settings'); return j; }
async function postManualRoundtrip(body){ const r=await fetch('/api/worker/manual/roundtrip-test', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||'manual_roundtrip_failed'); return j; }
async function postForceUnlock(body){ const r=await fetch('/api/worker/control/force-unlock', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||'force_unlock_failed'); return j; }

function normalizeWorkerPayload(payload){ if(!payload||typeof payload!=='object') return null; if(payload.worker&&typeof payload.worker==='object') return payload.worker; if(payload.result?.worker&&typeof payload.result.worker==='object') return payload.result.worker; if(payload.state||payload.trafficLight||payload.connected!==undefined) return payload; return null; }

function renderManualRoundtrip(rt){
  const stateEl=$('manualRoundtripState'), resultEl=$('manualRoundtripResult');
  if(!stateEl||!resultEl) return;
  if(!rt){ stateEl.textContent='-'; resultEl.textContent='-'; return; }
  const running=!!rt.running;
  const stage=String(rt.stage || (running?'RUNNING':'IDLE'));
  const mode=String(rt.mode || '-').toUpperCase();
  stateEl.textContent=`${running?'RUNNING':'IDLE'} | mode=${mode} | stage=${stage}`;
  resultEl.textContent=JSON.stringify(rt.last_result || rt.last_error || rt, null, 2);
}

function render(data){
  latestOverview=data;
  $('ts').textContent=`updated: ${new Date(data.now || Date.now()).toLocaleString()}${data.sourceOk?'':' | source unavailable'}`;
  const worker=data.worker||{};
  const light=String(worker.trafficLight||'DISCONNECTED').toUpperCase();
  const lightClass=light==='GREEN'?'ok':(light==='YELLOW'?'warn':'bad');
  const tf=$('trafficFixed');
  if (tf){
    const dot = light==='GREEN' ? 'ğŸŸ¢' : (light==='YELLOW' ? 'ğŸŸ¡' : 'ğŸ”´');
    tf.textContent = `${dot} ${light}`;
  }
  const banner=$('stopBanner');
  const market=$('marketOneLiner');
  const staleBanner=$('runtimeStatusBanner');
  const marketLine=String(data?.marketOneLiner||'').trim();
  const resolvedMode = resolveDisplayMode(data);
  const uiMode = resolvedMode.mode;
  const topBanner=$('modeTopBanner');
  if (topBanner){
    topBanner.textContent = uiMode === 'LIVE' ? 'LIVE' : 'PAPER';
    topBanner.className = `zone1 ${uiMode === 'LIVE' ? 'live' : 'paper'}`;
  }
  if(uiMode==='PAPER' && marketLine){ market.classList.add('show'); market.style.display='block'; market.textContent=marketLine; } else { market.classList.remove('show'); market.style.display='none'; market.textContent=''; }
  if(worker.stopAll){ banner.className='banner danger show'; banner.textContent=worker.banner||`${light}: ì „ì²´ ì¤‘ë‹¨`; } else { banner.className='banner danger'; banner.textContent=''; }
  if(data?.runtimeStatusStaleIgnored){ staleBanner.className='banner danger show'; staleBanner.textContent='runtimeStatus stale ignored'; }
  else { staleBanner.className='banner danger'; staleBanner.textContent=''; }

  const truth = data?.truth || data?.worker?.state?.truth || {};
  const truthMode = String(truth.mode || '-').toUpperCase();
  const truthPhase = String(truth.phase || 'STOPPED').toUpperCase();
  const truthRunning = Boolean(truth.running);
  const truthLock = truth.lock_exists ? 'on' : 'off';
  const truthText = `TRUTH=${truthMode} ${truthPhase} running=${truthRunning} lock=${truthLock}`;
  const truthBadge = $('truthBadge');
  const truthSource = $('truthSource');
  if (truthBadge){ truthBadge.textContent = truthText; truthBadge.className = phaseBadgeClass(truthPhase); }
  if (truthSource){ truthSource.textContent = String(truth.source || 'canonical:/api/v1/status+lock'); }

  const phase = phaseFromOverview(data); syncToggleUI(phase);
  const workerState = data?.worker?.state || {};
  const requiresConfirm = workerState?.requires_operator_confirm === true;
  const statusExpectedPhrase = String(workerState?.expected_phrase || workerState?.pending?.expected_phrase || '').trim();
  if (requiresConfirm && statusExpectedPhrase) pendingExpectedPhrase = statusExpectedPhrase;
  if (phase !== 'WAITING_OPERATOR' && !requiresConfirm) pendingExpectedPhrase = '';
  const backendMode = resolveDisplayMode(data).mode || String(workerState?.pending?.mode || selectedMode || 'PAPER').toUpperCase();
  if (backendMode==='PAPER' || backendMode==='LIVE') selectedMode = backendMode;
  setModeButtons();
  $('modeStatus').textContent = `ì„ íƒ ëª¨ë“œ: ${selectedMode} (source: ${resolvedMode.source}${data?.modeSource?`, api:${data.modeSource}`:''})`;
  setModeConfirmUI();
  setBlockedUI(data);
  const srvToggles = data?.exchangeToggles;
  if (srvToggles && typeof srvToggles==='object') exchangeToggles = { upbit: srvToggles.upbit !== false, bithumb: srvToggles.bithumb !== false };
  syncExchangeToggleUI();

  const acc = data.account || data.balance || data.portfolio || data.trading?.account || {};
  const positions = data.positions || data.trading?.positions || [];
  const pnlSource = data.pnl || data.trading?.pnl || {};
  $('account').innerHTML = `<table><tbody><tr><th>Equity</th><td>${esc(val(acc,['equity','totalEquity','netAsset']))}</td><th>Available</th><td>${esc(val(acc,['available','cash','availableBalance']))}</td></tr><tr><th>Margin</th><td>${esc(val(acc,['margin','usedMargin']))}</td><th>Daily PnL</th><td>${esc(val(pnlSource,['daily','dailyPnl','today']))}</td></tr><tr><th>Unrealized PnL</th><td>${esc(val(pnlSource,['unrealized','unrealizedPnl','uPnL']))}</td><th>Realized PnL</th><td>${esc(val(pnlSource,['realized','realizedPnl']))}</td></tr></tbody></table>`;

  const rows = Array.isArray(positions) ? positions : (Array.isArray(positions.list) ? positions.list : []);
  $('positions').innerHTML = !rows.length ? '<div class="muted">í¬ì§€ì…˜ ì—†ìŒ</div>' : `<table><thead><tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Mark</th><th>PnL</th></tr></thead><tbody>${rows.slice(0,20).map(p=>`<tr><td>${esc(val(p,['symbol','ticker']))}</td><td>${esc(val(p,['side','direction']))}</td><td>${esc(val(p,['qty','size','positionAmt']))}</td><td>${esc(val(p,['entry','entryPrice','avgPrice']))}</td><td>${esc(val(p,['mark','markPrice','lastPrice']))}</td><td>${esc(val(p,['pnl','unrealizedPnl','uPnL']))}</td></tr>`).join('')}</tbody></table>`;

  const watch = Array.isArray(data?.watchingSymbols) ? data.watchingSymbols : [];
  $('watchingList').innerHTML = watch.length ? watch.map((x)=>`<code>${esc(x)}</code>`).join(' ') : '<span class="muted">watchlist/symbols ë°ì´í„° ì—†ìŒ (fallback)</span>';

  const vc = data?.virtualCapital || data?.runtimeStatus?.virtual_capital || {};
  $('virtualCapitalMeta').innerHTML = `ê·œì¹™: <span class='mono'>current virtual_equity = next available capital</span><br/>í˜„ì¬ Virtual Equity: <b>${esc(fmtKrw(vc.equity_virtual ?? vc.next_available_capital))}</b> | ë‹¤ìŒ ê°€ìš©ìê¸ˆ: <b>${esc(fmtKrw(vc.next_available_capital ?? vc.available_for_bot))}</b><br/>Cap(total/upbit/bithumb): <b>${esc(fmtKrw(vc.total_cap_krw))}</b> / <b>${esc(fmtKrw(vc.upbit_cap_krw))}</b> / <b>${esc(fmtKrw(vc.bithumb_cap_krw))}</b>`;
  const reviewRows = Array.isArray(data?.yesterdayTradingReview) ? data.yesterdayTradingReview.slice(0,7) : [];
  $('reviewTable').innerHTML = reviewRows.length
    ? reviewRows.map((r)=>`<tr><td>${esc(r.date||'-')}</td><td>${esc(fmtKrw(r.pnl_krw))}</td><td>${esc(fmtKrw(r.virtual_equity))}</td><td>${esc(String(r.trades ?? '-'))}</td><td>${esc(String(r.source||'-'))}</td></tr>`).join('')
    : '<tr><td colspan="5" class="muted">ë¦¬ë·° ë°ì´í„° ì—†ìŒ (fallback)</td></tr>';

  renderCapitalChart(data?.capitalDailyGraph || null);

  const g = data?.capitalDailyGraph || {};
  const vcTotal = data?.virtualCapital || {};
  const setFundCard = (prefix, graph, totalCard=false) => {
    const hasData = Array.isArray(graph?.rows) && graph.rows.length > 0;
    const equityRaw = totalCard ? (vcTotal?.equity_virtual ?? graph?.current_equity) : graph?.current_equity;
    const equityNum = Number(equityRaw);
    const equity = Number.isFinite(equityNum) ? equityNum : null;
    const availRaw = totalCard
      ? (vcTotal?.available_for_bot ?? vcTotal?.next_available_capital ?? equity)
      : (hasData ? equity : null);
    const availNum = Number(availRaw);
    const avail = Number.isFinite(availNum) ? availNum : null;
    const delta = graph?.day_delta_krw;
    const noExchangeData = !totalCard && !hasData;
    $(prefix+'Equity').textContent = noExchangeData ? 'ë°ì´í„° ì—†ìŒ' : (Number.isFinite(Number(equity)) ? fmtKrw(equity) : '0 KRW');
    $(prefix+'Avail').textContent = noExchangeData ? 'ë°ì´í„° ì—†ìŒ' : (Number.isFinite(Number(avail)) ? fmtKrw(avail) : '0 KRW');
    $(prefix+'Delta').textContent = Number.isFinite(Number(delta)) ? `${Number(delta)>=0?'+':''}${Number(delta).toLocaleString()} KRW` : (noExchangeData ? 'ë°ì´í„° ì—†ìŒ' : '0 KRW');
  };
  setFundCard('fundTotal', g.total || {}, true);
  setFundCard('fundUpbit', g.upbit || {}, false);
  setFundCard('fundBithumb', g.bithumb || {}, false);

  const totalCap = data?.uiSettings?.total_cap_krw ?? data?.uiSettings?.capital_cap_krw;
  const upbitCap = data?.uiSettings?.upbit_cap_krw;
  const bithumbCap = data?.uiSettings?.bithumb_cap_krw;
  if (totalCap !== undefined && totalCap !== null) $('totalCapInput').value = String(totalCap);
  if (upbitCap !== undefined && upbitCap !== null) $('upbitCapInput').value = String(upbitCap);
  if (bithumbCap !== undefined && bithumbCap !== null) $('bithumbCapInput').value = String(bithumbCap);

  const indicators = data?.exchangeIndicators || {};
  const renderIndicator = (name, obj) => {
    const status = String(obj?.status || 'unknown').toLowerCase();
    const klass = status==='connected'?'ok':(status==='disconnected'?'bad':'warn');
    const detail = obj?.detail || 'state unavailable';
    return `<div><b>${name}</b>: <span class="${klass}">${esc(status.toUpperCase())}</span> <span class="muted">(${esc(detail)})</span></div>`;
  };
  $('connIndicators').innerHTML = renderIndicator('Upbit', indicators.upbit) + renderIndicator('Bithumb', indicators.bithumb) + `<div><b>Worker</b>: <b class="${lightClass}">${esc(light)}</b></div>`;

  const rt = data?.manual_roundtrip || data?.worker?.state?.manual_roundtrip || null;
  renderManualRoundtrip(rt);
}

function openConfirmModal(text){ return new Promise((resolve)=>{ const m=$('confirmModal'), a=$('confirmModalApprove'), c=$('confirmModalCancel'); $('confirmModalText').textContent=text; m.classList.add('show'); const done=(ok)=>{m.classList.remove('show'); a.removeEventListener('click',onA); c.removeEventListener('click',onC); resolve(ok);}; const onA=()=>done(true), onC=()=>done(false); a.addEventListener('click',onA); c.addEventListener('click',onC); }); }
async function runWithControlBusy(fn){ if(controlBusy) return; controlBusy=true; $('autoToggle').disabled=true; if($('forceUnlockBtn')) $('forceUnlockBtn').disabled=true; try{await fn();} finally{controlBusy=false; syncToggleUI(phaseFromOverview(latestOverview||{})); if($('forceUnlockBtn')) $('forceUnlockBtn').disabled=false;} }

async function handleModeChange(nextMode){
  if (nextMode === selectedMode) return;
  if (nextMode === 'LIVE') {
    const step1 = await openConfirmModal('LIVE ì „í™˜ 1/2: ì‹¤ê³„ì¢Œ ê±°ë˜ ìœ„í—˜ì„ ì´í•´í–ˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
    if (!step1) return;
    const step2 = await openConfirmModal('LIVE ì „í™˜ 2/2: ì •ë§ LIVE ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤. expected_phraseë¥¼ ìë™ ìˆ˜ì‹ í•©ë‹ˆë‹¤.');
    if (!step2) return;

    await runWithControlBusy(async()=>{
      const phase=phaseFromOverview(latestOverview||{});
      if (phase==='RUNNING') { $('controlStatus').textContent='ì´ë¯¸ RUNNING ìƒíƒœì…ë‹ˆë‹¤.'; return; }
      const exchange=pickStartExchange();
      if(!exchange) throw new Error('í™œì„± ê±°ë˜ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
      $('controlStatus').textContent='LIVE ëª¨ë“œ ì¤€ë¹„ ìš”ì²­ ì¤‘...';
      const started=await postControl('mode',{mode:'LIVE', exchange});
      const phaseAfter = String(started?.result?.phase || '').toUpperCase();
      if (phaseAfter === 'RUNNING') {
        pendingExpectedPhrase='';
        setModeConfirmUI();
        $('controlStatus').textContent='LIVE ì „í™˜ ì™„ë£Œ (modeâ†’confirm ìë™ ìˆ˜í–‰).';
        await tick();
        return;
      }
      pendingExpectedPhrase=String(started?.result?.expected_phrase || '').trim();
      setModeConfirmUI();
      if(!pendingExpectedPhrase) throw new Error('expected_phrase ëˆ„ë½');
      $('controlStatus').textContent='LIVE ì¤€ë¹„ ì™„ë£Œ: Confirm ë²„íŠ¼ì„ ëˆŒëŸ¬ ìµœì¢… ìŠ¹ì¸í•˜ì„¸ìš”.';
      await tick();
    });
  }
  selectedMode = nextMode;
  setModeButtons();
}

async function handleTurnOn(){ await runWithControlBusy(async()=>{ let phase=phaseFromOverview(latestOverview||{}); let expectedPhrase=pendingExpectedPhrase||latestOverview?.worker?.state?.expected_phrase||latestOverview?.worker?.state?.pending?.expected_phrase||null; if(phase==='STOPPED'){ $('controlStatus').textContent='ì‹œì‘ ìš”ì²­ ì¤‘...'; const exchange=pickStartExchange(); if(!exchange) throw new Error('í™œì„± ê±°ë˜ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. Upbit/Bithumb ì¤‘ 1ê°œ ì´ìƒ í™œì„±í™”í•˜ì„¸ìš”.'); const started=await postControl('mode',{mode:selectedMode, exchange}); const phaseAfter=String(started?.result?.phase||'').toUpperCase(); if(phaseAfter==='RUNNING'){ pendingExpectedPhrase=''; setModeConfirmUI(); $('controlStatus').textContent=`Auto Trading ON (${selectedMode})`; await tick(); return; } expectedPhrase=started?.result?.expected_phrase||expectedPhrase||null; if(!expectedPhrase) throw new Error('expected_phrase ëˆ„ë½'); pendingExpectedPhrase=String(expectedPhrase); setModeConfirmUI(); } else if(phase==='WAITING_OPERATOR'){ if(!expectedPhrase) throw new Error('pending expected_phrase ì—†ìŒ'); } else if(phase==='RUNNING'){ $('controlStatus').textContent='ì´ë¯¸ RUNNING ìƒíƒœì…ë‹ˆë‹¤.'; await tick(); return; } else throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” phase: ${phase}`);
    const approved=await openConfirmModal('ì‹œì‘ ìµœì¢… ìŠ¹ì¸: backend expected_phraseë¡œ confirmì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.'); if(!approved){ $('controlStatus').textContent='ì·¨ì†Œë¨'; await tick(); return; }
    $('controlStatus').textContent='ìŠ¹ì¸ë¨: ì‹œì‘ í™•ì • ì¤‘...'; await postControl('confirm',{phrase:expectedPhrase}); pendingExpectedPhrase=''; setModeConfirmUI(); $('controlStatus').textContent=`Auto Trading ON (${selectedMode})`; await tick();
  }); }
async function handleTurnOff(){ await runWithControlBusy(async()=>{ $('controlStatus').textContent='ì •ì§€ ìš”ì²­ ì¤‘...'; await postControl('stop',{}); $('controlStatus').textContent='Auto Trading OFF (STOPPED)'; await tick(); }); }

$('modePaperBtn').addEventListener('click', ()=>handleModeChange('PAPER').catch(async(e)=>{ setBlockedUI(e?.payload || toBlockedPayload(e?.payload?.result || {})); $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; await tick(); }));
$('modeLiveBtn').addEventListener('click', ()=>handleModeChange('LIVE').catch(async(e)=>{ setBlockedUI(e?.payload || toBlockedPayload(e?.payload?.result || {})); $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; await tick(); }));
$('modeConfirmBtn').addEventListener('click', async()=>{ try{ await runWithControlBusy(async()=>{ if(!pendingExpectedPhrase) throw new Error('expected_phrase ì—†ìŒ'); $('controlStatus').textContent='LIVE ìµœì¢… ìŠ¹ì¸ ì¤‘...'; await postControl('confirm',{phrase:pendingExpectedPhrase}); pendingExpectedPhrase=''; setModeConfirmUI(); await tick(); }); }catch(e){ setBlockedUI(e?.payload || toBlockedPayload(e?.payload?.result || {})); $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; } });
$('nextActionBtn').addEventListener('click', async()=>{
  const action=String($('nextActionBtn').dataset.action||'').trim();
  try{
    if(action==='confirm_start'){
      if(!pendingExpectedPhrase) throw new Error('expected_phrase ì—†ìŒ');
      await runWithControlBusy(async()=>{ $('controlStatus').textContent='ì°¨ë‹¨í•´ì œ(confirm) ì‹¤í–‰ ì¤‘...'; await postControl('confirm',{phrase:pendingExpectedPhrase}); pendingExpectedPhrase=''; setModeConfirmUI(); await tick(); });
      return;
    }
    if(action==='start'){
      await handleTurnOn();
      return;
    }
    $('controlStatus').textContent=`ì•ˆë‚´: ìˆ˜ë™ ì¡°ì¹˜ í•„ìš” (${action||'none'})`;
  }catch(e){ setBlockedUI(e?.payload || toBlockedPayload(e?.payload?.result || {})); $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; }
});
$('capitalViewTotal')?.addEventListener('click', ()=>{ capitalView='total'; setCapitalViewButtons(); renderCapitalChart(latestOverview?.capitalDailyGraph || null); });
$('capitalViewUpbit')?.addEventListener('click', ()=>{ capitalView='upbit'; setCapitalViewButtons(); renderCapitalChart(latestOverview?.capitalDailyGraph || null); });
$('capitalViewBithumb')?.addEventListener('click', ()=>{ capitalView='bithumb'; setCapitalViewButtons(); renderCapitalChart(latestOverview?.capitalDailyGraph || null); });
$('autoToggle').addEventListener('change', async(ev)=>{ if(syncingToggle) return; try{ if(ev.target.checked) await handleTurnOn(); else await handleTurnOff(); }catch(e){ setBlockedUI(e?.payload || toBlockedPayload(e?.payload?.result || {})); $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; await tick(); } });
$('runBtn')?.addEventListener('click', ()=>handleTurnOn().catch(async(e)=>{ $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; await tick(); }));
$('pauseBtn')?.addEventListener('click', ()=>handleTurnOff().catch(async(e)=>{ $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; await tick(); }));
$('stopBtn')?.addEventListener('click', ()=>handleTurnOff().catch(async(e)=>{ $('controlStatus').textContent=`ì‹¤íŒ¨: ${e.message}`; await tick(); }));
$('panicInlineBtn')?.addEventListener('mousedown', ()=>$('panicHoldBtn')?.dispatchEvent(new MouseEvent('mousedown')));
['mouseup','mouseleave'].forEach((ev)=>$('panicInlineBtn')?.addEventListener(ev, ()=>$('panicHoldBtn')?.dispatchEvent(new MouseEvent(ev))));

$('forceUnlockBtn')?.addEventListener('click', async()=>{
  try{
    const ok = await openConfirmModal('ì •ë§ Lock ê°•ì œí•´ì œë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? stale lock í•´ì œ ëª©ì  ì™¸ì—ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.');
    if(!ok) return;
    await runWithControlBusy(async()=>{
      const exchange = pickStartExchange() || String(latestOverview?.runtimeStatus?.exchange || 'UPBIT').toUpperCase();
      const seed = Number(latestOverview?.runtimeStatus?.seed_krw ?? latestOverview?.virtualCapital?.seed_krw ?? 0) || 0;
      $('controlStatus').textContent='Lock ê°•ì œí•´ì œ ìš”ì²­ ì¤‘...';
      const out = await postForceUnlock({ mode: selectedMode, exchange, seed });
      const route = out?.backendRoute ? ` (${out.backendRoute})` : '';
      const msg = out?.message || out?.result?.message || 'stale lock í•´ì œ ìš”ì²­ ì„±ê³µ';
      setBlockedUI({ worker: { state: { why_blocked: `FORCE-UNLOCK OK: ${msg}${route}`, next_action: 'start' } } });
      $('controlStatus').textContent = `Force Unlock ì„±ê³µ: ${msg}${route}`;
      await tick();
    });
  }catch(e){
    setBlockedUI({ worker: { state: { why_blocked: `FORCE-UNLOCK ì‹¤íŒ¨: ${e.message}`, next_action: '' } } });
    $('controlStatus').textContent=`Force Unlock ì‹¤íŒ¨: ${e.message}`;
    await tick();
  }
});

async function handleExchangeToggleChange(){
  if(syncingExchangeToggle) return;
  const next={ upbit:$('upbitToggle').checked, bithumb:$('bithumbToggle').checked };
  if(!next.upbit && !next.bithumb){
    $('exchangeToggleStatus').textContent='ì‹¤íŒ¨: ìµœì†Œ 1ê°œ ê±°ë˜ì†ŒëŠ” í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.';
    syncExchangeToggleUI();
    return;
  }
  exchangeToggles=next;
  syncExchangeToggleUI();
  try{
    const out=await postExchangeToggles({ mode:selectedMode, upbitEnabled:next.upbit, bithumbEnabled:next.bithumb });
    const route=out?.backendRoute?` (${out.backendRoute})`:'';
    $('exchangeToggleStatus').textContent=`ì ìš©ë¨: Upbit=${next.upbit?'í™œì„±':'ë¹„í™œì„±'}, Bithumb=${next.bithumb?'í™œì„±':'ë¹„í™œì„±'}${route}`;
  }catch(e){
    $('exchangeToggleStatus').textContent=`ì‹¤íŒ¨: ${e.message}`;
  }
}
$('upbitToggle').addEventListener('change', handleExchangeToggleChange);
$('bithumbToggle').addEventListener('change', handleExchangeToggleChange);
$('capitalCapSaveBtn').addEventListener('click', async()=>{
  const parseCap = (id) => {
    const raw = String($(id).value || '').replace(/,/g,'').trim();
    const n = Number(raw === '' ? '0' : raw);
    if(!Number.isFinite(n) || n < 0) throw new Error(`${id}: 0 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
    return Math.floor(n);
  };
  try{
    const total = parseCap('totalCapInput');
    const upbit = parseCap('upbitCapInput');
    const bithumb = parseCap('bithumbCapInput');
    const out = await postUiSettings({
      total_cap_krw: total,
      capital_cap_krw: total,
      upbit_cap_krw: upbit,
      bithumb_cap_krw: bithumb,
    });
    const route = out?.backendRoute ? ` (${out.backendRoute})` : ' (file-save)';
    $('capitalCapStatus').textContent=`ì €ì¥ë¨: total=${total.toLocaleString()}, upbit=${upbit.toLocaleString()}, bithumb=${bithumb.toLocaleString()}${route}`;
    await tick();
  }catch(e){
    $('capitalCapStatus').textContent=`ì‹¤íŒ¨: ${e.message}`;
  }
});
const panicSlider=$('panicSlider'), panicValue=$('panicValue'), panicStatus=$('panicStatus'), panicHoldBtn=$('panicHoldBtn'); let holdTimer=null, holdStart=0;
panicSlider.addEventListener('input',()=>{panicValue.textContent=panicSlider.value;});
panicHoldBtn.addEventListener('mousedown',()=>{ if(Number(panicSlider.value)<100){panicStatus.textContent='ì‹¤íŒ¨: ìŠ¬ë¼ì´ë”ë¥¼ 100ìœ¼ë¡œ ì˜¬ë¦¬ì„¸ìš”'; return;} holdStart=Date.now(); panicStatus.textContent='í™€ë“œ ì¤‘...'; holdTimer=setTimeout(async()=>{ try{const out=await postControl('panic',{armed:true,holdMs:Date.now()-holdStart,slider:Number(panicSlider.value)}); panicStatus.textContent=`PANIC ì‹¤í–‰ë¨ (${out?.result?.status||'ok'})`; await tick();}catch(e){panicStatus.textContent=`ì‹¤íŒ¨: ${e.message}`;} },2000);});
['mouseup','mouseleave'].forEach((ev)=> panicHoldBtn.addEventListener(ev,()=>{ if(holdTimer){clearTimeout(holdTimer); holdTimer=null; if(Date.now()-holdStart<2000) panicStatus.textContent='ì·¨ì†Œë¨: 2ì´ˆ ì´ìƒ í™€ë“œ í•„ìš”'; }}));

$('orderCancelBtn').addEventListener('click', async()=>{ const orderId=String($('orderIdInput').value||'').trim(); if(!orderId){$('orderStatus').textContent='ì‹¤íŒ¨: orderId ì…ë ¥ í•„ìš”';return;} try{const out=await postControl('cancel-order',{orderId}); $('orderStatus').textContent=`ì·¨ì†Œ ìš”ì²­ ì„±ê³µ: ${out?.result?.orderId||orderId}`; await tick();}catch(e){$('orderStatus').textContent=`ì‹¤íŒ¨: ${e.message}`;} });
$('manualRoundtripRunBtn')?.addEventListener('click', async()=>{
  const stateEl=$('manualRoundtripState');
  const resultEl=$('manualRoundtripResult');
  try{
    const symbol=String($('manualRoundtripSymbol')?.value||'').trim() || 'KRW-XRP';
    const krw_notional=Math.floor(Number(String($('manualRoundtripNotional')?.value||'').replace(/,/g,'')));
    const buy_offset_ticks=Math.floor(Number(String($('manualRoundtripBuyOffsetTicks')?.value||'').replace(/,/g,'')));
    const hold_seconds=Math.floor(Number(String($('manualRoundtripHoldSeconds')?.value||'').replace(/,/g,'')));
    const bid_minus_ticks=Math.floor(Number(String($('manualRoundtripBidMinusTicks')?.value||'').replace(/,/g,'')));
    const confirm=String($('manualRoundtripConfirm')?.value||'').trim();
    if(!Number.isFinite(krw_notional)||krw_notional<=0) throw new Error('krw_notionalì€ 0ë³´ë‹¤ í° ìˆ«ì í•„ìš”');
    if(!Number.isFinite(buy_offset_ticks)) throw new Error('buy_offset_ticks ìˆ«ì í•„ìš”');
    if(!Number.isFinite(hold_seconds)||hold_seconds<=0) throw new Error('hold_secondsëŠ” 0ë³´ë‹¤ í° ìˆ«ì í•„ìš”');
    if(!Number.isFinite(bid_minus_ticks)||bid_minus_ticks<0) throw new Error('bid_minus_ticksëŠ” 0 ì´ìƒì˜ ìˆ«ì í•„ìš”');

    stateEl.textContent='ìš”ì²­ ì¤‘...';
    const payload={ symbol, krw_notional, buy_offset_ticks, hold_seconds, bid_minus_ticks, confirm };
    const out=await postManualRoundtrip(payload);
    stateEl.textContent=out?.message || 'accepted';
    resultEl.textContent=JSON.stringify(out?.manual_roundtrip || out?.result || out, null, 2);
    renderManualRoundtrip(out?.manual_roundtrip || null);
    await tick();
  }catch(e){
    stateEl.textContent=`ì‹¤íŒ¨: ${e.message}`;
    resultEl.textContent=JSON.stringify({ error: String(e?.message||e) }, null, 2);
  }
});
function setManualRefreshState(){ const btn=$('refreshConnBtn'), label=$('refreshConnState'); btn.disabled=manualRefreshBusy; btn.innerHTML=manualRefreshBusy?'<span class="spinner"></span> ìƒˆë¡œê³ ì¹¨ ì¤‘...':'ì—°ê²° ìƒíƒœ ìƒˆë¡œê³ ì¹¨'; const t=lastManualRefreshAt?new Date(lastManualRefreshAt).toLocaleTimeString():'-'; label.textContent=lastManualRefreshError?`ìˆ˜ë™ ê°±ì‹  ì‹¤íŒ¨: ${lastManualRefreshError}`:`ìˆ˜ë™ ê°±ì‹ : ${t}`; }
$('refreshConnBtn').addEventListener('click', async()=>{ if(manualRefreshBusy) return; manualRefreshBusy=true; setManualRefreshState(); try{ const [workerPayload, overview] = await Promise.all([fetchJson('/api/worker'), fetchJson(overviewUrl())]); const worker = normalizeWorkerPayload(workerPayload); if(worker) overview.worker=worker; render(overview); lastManualRefreshAt=Date.now(); lastManualRefreshError=''; }catch(e){ lastManualRefreshError=e.message; } finally { manualRefreshBusy=false; setManualRefreshState(); }});

async function tick(){ try{ render(await fetchJson(overviewUrl())); }catch(e){ $('ts').textContent='fetch failed: '+e.message; } }
setModeButtons(); setModeConfirmUI(); setCapitalViewButtons(); setManualRefreshState(); tick(); setInterval(tick, 1000);
</script>
</body>
</html>