<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto Trading Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0f1115;color:#e9edf1;margin:0;padding:16px}
    h1{margin:0;font-size:22px}
    h2{margin:0 0 10px;font-size:17px}
    .muted{color:#9aa4b2;font-size:12px}
    .ok{color:#47d16c}.warn{color:#ffca5f}.bad{color:#ff6b6b}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;margin-top:12px}
    .card{background:#161a22;border:1px solid #252b36;border-radius:10px;padding:12px}
    .banner{display:none;margin:12px 0 0;padding:10px 12px;border-radius:8px;font-weight:700}
    .banner.show{display:block}
    .banner.danger{background:#4a1318;border:1px solid #a8323d;color:#ffd7dc}
    .btn{background:#243047;border:1px solid #33425f;color:#e9edf1;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type="text"]{flex:1;background:#111722;border:1px solid #2a3342;color:#e9edf1;border-radius:6px;padding:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:7px;border-bottom:1px solid #262d38;text-align:left;vertical-align:top}
    code{background:#1f2530;padding:1px 5px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Auto Trading Dashboard</h1>
  <div class="muted" id="ts">loading...</div>
  <div id="stopBanner" class="banner danger"></div>

  <div class="grid">
    <div class="card">
      <h2>Worker Safety / Traffic Light</h2>
      <div id="worker"></div>
    </div>

    <div class="card">
      <h2>Panic 안전장치</h2>
      <div class="muted">1) 슬라이더를 100으로 이동 2) HOLD 2초 유지</div>
      <div style="margin-top:8px">
        <input id="panicSlider" type="range" min="0" max="100" step="1" value="0" style="width:100%" />
        <div class="muted">value: <span id="panicValue">0</span></div>
      </div>
      <button id="panicHoldBtn" class="btn" style="margin-top:8px">HOLD TO PANIC</button>
      <div id="panicStatus" class="muted" style="margin-top:8px">대기중</div>
    </div>

    <div class="card">
      <h2>Orders 취소</h2>
      <div class="muted">주문 ID 입력 후 Cancel 클릭</div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input id="orderIdInput" type="text" placeholder="ORD-001" />
        <button id="orderCancelBtn" class="btn">Cancel Order</button>
      </div>
      <div id="orderStatus" class="muted" style="margin-top:8px">대기중</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>계좌 / 포지션 / PnL</h2>
    <div id="account"></div>
    <div id="positions" style="margin-top:10px"></div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
function esc(s){return String(s??'').replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]))}

function val(obj, keys, fallback='-') {
  for (const k of keys) {
    const v = obj?.[k];
    if (v !== undefined && v !== null && v !== '') return v;
  }
  return fallback;
}

function render(data){
  $('ts').textContent = `updated: ${new Date(data.now || Date.now()).toLocaleString()}${data.sourceOk?'':'  |  openclaw json source unavailable'}`;

  const worker = data.worker || {};
  const light = String(worker.trafficLight || 'DISCONNECTED').toUpperCase();
  const lightClass = light === 'GREEN' ? 'ok' : (light === 'YELLOW' ? 'warn' : 'bad');
  $('worker').innerHTML = `<div><b>traffic light</b>: <b class="${lightClass}">${esc(light)}</b></div>
    <div><b>connected</b>: ${worker.connected===true?'<span class="ok">yes</span>':'<span class="bad">no</span>'}</div>
    <div><b>stop all</b>: ${worker.stopAll?'<span class="bad">ACTIVE</span>':'<span class="ok">off</span>'}</div>
    <div><b>updated</b>: ${worker.ts?esc(new Date(worker.ts).toLocaleTimeString()):'-'}</div>`;

  const banner = $('stopBanner');
  if (worker.stopAll) {
    banner.className = 'banner danger show';
    banner.textContent = worker.banner || `${light}: 전체 중단`;
  } else {
    banner.className = 'banner danger';
    banner.textContent = '';
  }

  const acc = data.account || data.balance || data.portfolio || data.trading?.account || {};
  const positions = data.positions || data.trading?.positions || [];
  const pnlSource = data.pnl || data.trading?.pnl || {};

  const equity = val(acc, ['equity','totalEquity','netAsset']);
  const available = val(acc, ['available','cash','availableBalance']);
  const margin = val(acc, ['margin','usedMargin']);
  const unrealized = val(pnlSource, ['unrealized','unrealizedPnl','uPnL']);
  const realized = val(pnlSource, ['realized','realizedPnl']);
  const daily = val(pnlSource, ['daily','dailyPnl','today']);

  $('account').innerHTML = `<table><tbody>
    <tr><th>Equity</th><td>${esc(equity)}</td><th>Available</th><td>${esc(available)}</td></tr>
    <tr><th>Margin</th><td>${esc(margin)}</td><th>Daily PnL</th><td>${esc(daily)}</td></tr>
    <tr><th>Unrealized PnL</th><td>${esc(unrealized)}</td><th>Realized PnL</th><td>${esc(realized)}</td></tr>
  </tbody></table>`;

  const rows = Array.isArray(positions) ? positions : (Array.isArray(positions.list) ? positions.list : []);
  if (!rows.length) {
    $('positions').innerHTML = '<div class="muted">포지션 없음</div>';
  } else {
    $('positions').innerHTML = `<table><thead><tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Mark</th><th>PnL</th></tr></thead><tbody>`+
      rows.slice(0, 20).map(p=>`<tr>
        <td>${esc(val(p,['symbol','ticker']))}</td>
        <td>${esc(val(p,['side','direction']))}</td>
        <td>${esc(val(p,['qty','size','positionAmt']))}</td>
        <td>${esc(val(p,['entry','entryPrice','avgPrice']))}</td>
        <td>${esc(val(p,['mark','markPrice','lastPrice']))}</td>
        <td>${esc(val(p,['pnl','unrealizedPnl','uPnL']))}</td>
      </tr>`).join('')+
      `</tbody></table>`;
  }
}

async function postControl(action, body){
  const r = await fetch(`/api/worker/control/${action}`, {
    method: 'POST',
    headers: {'content-type':'application/json'},
    body: JSON.stringify(body || {}),
  });
  const j = await r.json();
  if(!r.ok || j.ok===false) throw new Error(j.error || `control_failed:${action}`);
  return j;
}

const panicSlider = $('panicSlider');
const panicValue = $('panicValue');
const panicStatus = $('panicStatus');
const panicHoldBtn = $('panicHoldBtn');
let holdTimer = null;
let holdStart = 0;

panicSlider.addEventListener('input', ()=>{ panicValue.textContent = panicSlider.value; });

panicHoldBtn.addEventListener('mousedown', ()=>{
  if (Number(panicSlider.value) < 100) {
    panicStatus.textContent = '실패: 슬라이더를 100으로 올리세요';
    return;
  }
  holdStart = Date.now();
  panicStatus.textContent = '홀드 중...';
  holdTimer = setTimeout(async ()=>{
    try {
      const out = await postControl('panic', { armed: true, holdMs: Date.now()-holdStart, slider: Number(panicSlider.value) });
      panicStatus.textContent = `PANIC 실행됨 (${out?.result?.status || 'ok'})`;
      await tick();
    } catch (e) {
      panicStatus.textContent = `실패: ${e.message}`;
    }
  }, 2000);
});

['mouseup','mouseleave'].forEach((ev)=> panicHoldBtn.addEventListener(ev, ()=>{
  if (holdTimer) {
    clearTimeout(holdTimer);
    holdTimer = null;
    if (Date.now() - holdStart < 2000) panicStatus.textContent = '취소됨: 2초 이상 홀드 필요';
  }
}));

$('orderCancelBtn').addEventListener('click', async ()=>{
  const orderId = String($('orderIdInput').value || '').trim();
  if (!orderId) {
    $('orderStatus').textContent = '실패: orderId 입력 필요';
    return;
  }
  try {
    const out = await postControl('cancel-order', { orderId });
    $('orderStatus').textContent = `취소 요청 성공: ${out?.result?.orderId || orderId} (${out?.result?.status || 'ok'})`;
    await tick();
  } catch (e) {
    $('orderStatus').textContent = `실패: ${e.message}`;
  }
});

async function tick(){
  try{
    const r=await fetch('/api/overview');
    const j=await r.json();
    render(j);
  }catch(e){$('ts').textContent='fetch failed: '+e.message}
}

tick(); setInterval(tick, 1000);
</script>
</body>
</html>
