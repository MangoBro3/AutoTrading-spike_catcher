<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto Trading Cockpit</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0f1115;color:#e9edf1;margin:0;padding:16px}
    h1{margin:0;font-size:22px} h2{margin:0 0 10px;font-size:17px}
    .muted{color:#9aa4b2;font-size:12px}.ok{color:#47d16c}.warn{color:#ffca5f}.bad{color:#ff6b6b}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;margin-top:12px}
    .card{background:#161a22;border:1px solid #252b36;border-radius:10px;padding:12px}
    .banner{display:none;margin:12px 0 0;padding:10px 12px;border-radius:8px;font-weight:700}
    .banner.show{display:block}.banner.danger{background:#4a1318;border:1px solid #a8323d;color:#ffd7dc}
    .btn{background:#243047;border:1px solid #33425f;color:#e9edf1;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}.btn-danger{background:#4a1f24;border-color:#7a2f39;color:#ffd7dc}
    .btn-selected{background:#2e6f43;border-color:#3a8854}
    .inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px}
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid #5d6a81;border-top-color:#e9edf1;border-radius:50%;animation:spin .7s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    input[type="text"]{flex:1;background:#111722;border:1px solid #2a3342;color:#e9edf1;border-radius:6px;padding:6px}
    table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:7px;border-bottom:1px solid #262d38;text-align:left;vertical-align:top}
    .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent}
    .pill-stop{background:#3a2024;color:#ffb7c0;border-color:#6f303a}.pill-wait{background:#3d3320;color:#ffd98e;border-color:#72603b}.pill-run{background:#1f3a2a;color:#9ff1bc;border-color:#356a4a}
    .switch-wrap{display:flex;align-items:center;gap:10px;margin:8px 0}.switch{position:relative;display:inline-block;width:52px;height:30px}
    .switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;inset:0;background:#394253;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background:#2e6f43} input:checked + .slider:before{transform:translateX(22px)} input:disabled + .slider{opacity:.5;cursor:not-allowed}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}.modal.show{display:flex}
    .modal-card{width:min(460px,92vw);background:#161a22;border:1px solid #2f3745;border-radius:10px;padding:14px}.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  </style>
</head>
<body>
  <h1>Auto Trading Cockpit</h1>
  <div class="muted" id="ts">loading...</div>
  <div class="inline"><button id="refreshConnBtn" class="btn">연결 상태 새로고침</button><span id="refreshConnState" class="muted">수동 갱신: -</span></div>
  <div id="stopBanner" class="banner danger"></div>
  <div id="marketOneLiner" class="banner" style="display:none;background:#1e3a27;border:1px solid #3f7a58;color:#d7ffe6"></div>

  <div class="grid">
    <div class="card">
      <h2>거래 모드</h2>
      <div class="muted">LIVE 전환은 2단 확인 필수</div>
      <div class="inline">
        <button id="modePaperBtn" class="btn">PAPER</button>
        <button id="modeLiveBtn" class="btn btn-danger">LIVE</button>
      </div>
      <div id="modeStatus" class="muted" style="margin-top:8px"></div>
      <div style="margin-top:10px">
        <div class="muted">거래소 활성화</div>
        <div class="switch-wrap" style="margin-top:6px">
          <label class="switch"><input id="upbitToggle" type="checkbox" checked /><span class="slider"></span></label>
          <span style="min-width:58px">Upbit</span>
          <span id="upbitToggleLabel" class="muted">활성</span>
        </div>
        <div class="switch-wrap">
          <label class="switch"><input id="bithumbToggle" type="checkbox" checked /><span class="slider"></span></label>
          <span style="min-width:58px">Bithumb</span>
          <span id="bithumbToggleLabel" class="muted">활성</span>
        </div>
        <div id="exchangeToggleStatus" class="muted">거래소 토글 대기중</div>
      </div>
    </div>

    <div class="card">
      <h2>Auto Trading ON/OFF</h2>
      <div style="margin-top:8px">현재 상태: <span id="controlPhaseBadge" class="pill pill-stop">STOPPED</span></div>
      <div class="switch-wrap">
        <label class="switch"><input id="autoToggle" type="checkbox" /><span class="slider"></span></label>
        <span id="autoToggleLabel" style="font-weight:700">OFF</span>
      </div>
      <div id="controlStatus" class="muted">대기중</div>
    </div>

    <div class="card">
      <h2>연결 인디케이터</h2>
      <div id="connIndicators"></div>
    </div>

    <div class="card">
      <h2>Watching 종목</h2>
      <div id="watchingList" class="muted">불러오는 중...</div>
    </div>

    <div class="card">
      <h2>Panic 안전장치</h2>
      <div class="muted">1) 슬라이더를 100으로 이동 2) HOLD 2초 유지</div>
      <div style="margin-top:8px"><input id="panicSlider" type="range" min="0" max="100" step="1" value="0" style="width:100%" /><div class="muted">value: <span id="panicValue">0</span></div></div>
      <button id="panicHoldBtn" class="btn" style="margin-top:8px">HOLD TO PANIC</button>
      <div id="panicStatus" class="muted" style="margin-top:8px">대기중</div>
    </div>

    <div class="card">
      <h2>Orders 취소</h2>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="orderIdInput" type="text" placeholder="ORD-001" /><button id="orderCancelBtn" class="btn">Cancel Order</button></div>
      <div id="orderStatus" class="muted" style="margin-top:8px">대기중</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px"><h2>계좌 / 포지션 / PnL</h2><div id="account"></div><div id="positions" style="margin-top:10px"></div></div>

  <div id="confirmModal" class="modal"><div class="modal-card"><h2 style="margin-bottom:8px">확인</h2><div id="confirmModalText" class="muted" style="font-size:13px"></div><div class="modal-actions"><button id="confirmModalCancel" class="btn">취소</button><button id="confirmModalApprove" class="btn btn-danger">승인</button></div></div></div>

<script>
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s??'').replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
const val = (obj, keys, fallback='-') => { for (const k of keys){const v=obj?.[k]; if(v!==undefined&&v!==null&&v!=='') return v;} return fallback; };

let latestOverview=null, controlBusy=false, syncingToggle=false, syncingExchangeToggle=false;
let manualRefreshBusy=false, lastManualRefreshAt=null, lastManualRefreshError='';
let selectedMode='PAPER';
let exchangeToggles={upbit:true,bithumb:true};

function phaseFromOverview(data){ return String(data?.worker?.state?.phase || data?.worker?.phase || data?.phase || 'STOPPED').toUpperCase(); }
function isAutoOnByPhase(phase){ return phase==='RUNNING'||phase==='WAITING_OPERATOR'; }
function phaseBadgeClass(phase){ if(phase==='RUNNING') return 'pill pill-run'; if(phase==='WAITING_OPERATOR') return 'pill pill-wait'; return 'pill pill-stop'; }
function syncToggleUI(phase){ syncingToggle=true; const checked=isAutoOnByPhase(phase); $('autoToggle').checked=checked; $('autoToggle').disabled=controlBusy; $('autoToggleLabel').textContent=checked?'ON':'OFF'; const b=$('controlPhaseBadge'); b.className=phaseBadgeClass(phase); b.textContent=phase; syncingToggle=false; }
function setModeButtons(){ $('modePaperBtn').classList.toggle('btn-selected', selectedMode==='PAPER'); $('modeLiveBtn').classList.toggle('btn-selected', selectedMode==='LIVE'); $('modeStatus').textContent = `선택 모드: ${selectedMode}`; }

function syncExchangeToggleUI(){
  syncingExchangeToggle=true;
  $('upbitToggle').checked=!!exchangeToggles.upbit;
  $('bithumbToggle').checked=!!exchangeToggles.bithumb;
  $('upbitToggleLabel').textContent=exchangeToggles.upbit?'활성':'비활성';
  $('bithumbToggleLabel').textContent=exchangeToggles.bithumb?'활성':'비활성';
  syncingExchangeToggle=false;
}
function pickStartExchange(){
  const runtimeExchange=String(latestOverview?.runtimeStatus?.exchange || '').toUpperCase();
  if (runtimeExchange==='UPBIT' && exchangeToggles.upbit) return 'UPBIT';
  if (runtimeExchange==='BITHUMB' && exchangeToggles.bithumb) return 'BITHUMB';
  if (exchangeToggles.upbit) return 'UPBIT';
  if (exchangeToggles.bithumb) return 'BITHUMB';
  return null;
}

function overviewUrl(){ return '/api/overview'; }
async function fetchJson(url){ const r=await fetch(url); const j=await r.json(); if(!r.ok) throw new Error(`${url} ${r.status}`); return j; }
async function postControl(action, body){ const r=await fetch(`/api/worker/control/${action}`, {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||`control_failed:${action}`); if(j?.result?.ok===false) throw new Error(j?.result?.detail||j?.result?.error||`worker_control_failed:${action}`); return j; }
async function postExchangeToggles(body){ const r=await fetch('/api/worker/control/exchanges', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body||{})}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||'control_failed:exchanges'); return j; }

function normalizeWorkerPayload(payload){ if(!payload||typeof payload!=='object') return null; if(payload.worker&&typeof payload.worker==='object') return payload.worker; if(payload.result?.worker&&typeof payload.result.worker==='object') return payload.result.worker; if(payload.state||payload.trafficLight||payload.connected!==undefined) return payload; return null; }

function render(data){
  latestOverview=data;
  $('ts').textContent=`updated: ${new Date(data.now || Date.now()).toLocaleString()}${data.sourceOk?'':' | source unavailable'}`;
  const worker=data.worker||{};
  const light=String(worker.trafficLight||'DISCONNECTED').toUpperCase();
  const lightClass=light==='GREEN'?'ok':(light==='YELLOW'?'warn':'bad');
  const banner=$('stopBanner');
  const market=$('marketOneLiner');
  const marketLine=String(data?.marketOneLiner||'').trim();
  const uiMode = String(data?.runtimeStatus?.mode || selectedMode || '').toUpperCase();
  if(uiMode==='PAPER' && marketLine){ market.classList.add('show'); market.style.display='block'; market.textContent=marketLine; } else { market.classList.remove('show'); market.style.display='none'; market.textContent=''; }
  if(worker.stopAll){ banner.className='banner danger show'; banner.textContent=worker.banner||`${light}: 전체 중단`; } else { banner.className='banner danger'; banner.textContent=''; }

  const phase = phaseFromOverview(data); syncToggleUI(phase);
  const backendMode = String(data?.runtimeStatus?.mode || data?.worker?.state?.pending?.mode || selectedMode || 'PAPER').toUpperCase();
  if (backendMode==='PAPER' || backendMode==='LIVE') selectedMode = backendMode;
  setModeButtons();
  const srvToggles = data?.exchangeToggles;
  if (srvToggles && typeof srvToggles==='object') exchangeToggles = { upbit: srvToggles.upbit !== false, bithumb: srvToggles.bithumb !== false };
  syncExchangeToggleUI();

  const acc = data.account || data.balance || data.portfolio || data.trading?.account || {};
  const positions = data.positions || data.trading?.positions || [];
  const pnlSource = data.pnl || data.trading?.pnl || {};
  $('account').innerHTML = `<table><tbody><tr><th>Equity</th><td>${esc(val(acc,['equity','totalEquity','netAsset']))}</td><th>Available</th><td>${esc(val(acc,['available','cash','availableBalance']))}</td></tr><tr><th>Margin</th><td>${esc(val(acc,['margin','usedMargin']))}</td><th>Daily PnL</th><td>${esc(val(pnlSource,['daily','dailyPnl','today']))}</td></tr><tr><th>Unrealized PnL</th><td>${esc(val(pnlSource,['unrealized','unrealizedPnl','uPnL']))}</td><th>Realized PnL</th><td>${esc(val(pnlSource,['realized','realizedPnl']))}</td></tr></tbody></table>`;

  const rows = Array.isArray(positions) ? positions : (Array.isArray(positions.list) ? positions.list : []);
  $('positions').innerHTML = !rows.length ? '<div class="muted">포지션 없음</div>' : `<table><thead><tr><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Mark</th><th>PnL</th></tr></thead><tbody>${rows.slice(0,20).map(p=>`<tr><td>${esc(val(p,['symbol','ticker']))}</td><td>${esc(val(p,['side','direction']))}</td><td>${esc(val(p,['qty','size','positionAmt']))}</td><td>${esc(val(p,['entry','entryPrice','avgPrice']))}</td><td>${esc(val(p,['mark','markPrice','lastPrice']))}</td><td>${esc(val(p,['pnl','unrealizedPnl','uPnL']))}</td></tr>`).join('')}</tbody></table>`;

  const watch = Array.isArray(data?.watchingSymbols) ? data.watchingSymbols : [];
  $('watchingList').innerHTML = watch.length ? watch.map((x)=>`<code>${esc(x)}</code>`).join(' ') : '<span class="muted">watchlist/symbols 데이터 없음 (fallback)</span>';

  const indicators = data?.exchangeIndicators || {};
  const renderIndicator = (name, obj) => {
    const status = String(obj?.status || 'unknown').toLowerCase();
    const klass = status==='connected'?'ok':(status==='disconnected'?'bad':'warn');
    const detail = obj?.detail || 'state unavailable';
    return `<div><b>${name}</b>: <span class="${klass}">${esc(status.toUpperCase())}</span> <span class="muted">(${esc(detail)})</span></div>`;
  };
  $('connIndicators').innerHTML = renderIndicator('Upbit', indicators.upbit) + renderIndicator('Bithumb', indicators.bithumb) + `<div><b>Worker</b>: <b class="${lightClass}">${esc(light)}</b></div>`;
}

function openConfirmModal(text){ return new Promise((resolve)=>{ const m=$('confirmModal'), a=$('confirmModalApprove'), c=$('confirmModalCancel'); $('confirmModalText').textContent=text; m.classList.add('show'); const done=(ok)=>{m.classList.remove('show'); a.removeEventListener('click',onA); c.removeEventListener('click',onC); resolve(ok);}; const onA=()=>done(true), onC=()=>done(false); a.addEventListener('click',onA); c.addEventListener('click',onC); }); }
async function runWithControlBusy(fn){ if(controlBusy) return; controlBusy=true; $('autoToggle').disabled=true; try{await fn();} finally{controlBusy=false; syncToggleUI(phaseFromOverview(latestOverview||{}));} }

async function handleModeChange(nextMode){
  if (nextMode === selectedMode) return;
  if (nextMode === 'LIVE') {
    const step1 = await openConfirmModal('LIVE 전환 1/2: 실계좌 거래 위험을 이해했습니다. 계속하시겠습니까?');
    if (!step1) return;
    const step2 = await openConfirmModal('LIVE 전환 2/2: 정말 LIVE 모드로 전환합니다. 승인 시 이후 시작 요청이 LIVE로 전송됩니다.');
    if (!step2) return;
  }
  selectedMode = nextMode;
  setModeButtons();
}

async function handleTurnOn(){ await runWithControlBusy(async()=>{ let phase=phaseFromOverview(latestOverview||{}); let expectedPhrase=latestOverview?.worker?.state?.pending?.expected_phrase||null; if(phase==='STOPPED'){ $('controlStatus').textContent='시작 요청 중...'; const exchange=pickStartExchange(); if(!exchange) throw new Error('활성 거래소가 없습니다. Upbit/Bithumb 중 1개 이상 활성화하세요.'); const started=await postControl('start',{mode:selectedMode, exchange}); expectedPhrase=started?.result?.expected_phrase||expectedPhrase; if(!expectedPhrase) throw new Error('expected_phrase 누락'); } else if(phase==='WAITING_OPERATOR'){ if(!expectedPhrase) throw new Error('pending expected_phrase 없음'); } else if(phase==='RUNNING'){ $('controlStatus').textContent='이미 RUNNING 상태입니다.'; await tick(); return; } else throw new Error(`지원하지 않는 phase: ${phase}`);
    const approved=await openConfirmModal('시작 최종 승인: backend expected_phrase로 confirm을 수행합니다.'); if(!approved){ $('controlStatus').textContent='취소됨'; await tick(); return; }
    $('controlStatus').textContent='승인됨: 시작 확정 중...'; await postControl('confirm',{phrase:expectedPhrase}); $('controlStatus').textContent=`Auto Trading ON (${selectedMode})`; await tick();
  }); }
async function handleTurnOff(){ await runWithControlBusy(async()=>{ $('controlStatus').textContent='정지 요청 중...'; await postControl('stop',{}); $('controlStatus').textContent='Auto Trading OFF (STOPPED)'; await tick(); }); }

$('modePaperBtn').addEventListener('click', ()=>handleModeChange('PAPER'));
$('modeLiveBtn').addEventListener('click', ()=>handleModeChange('LIVE'));
$('autoToggle').addEventListener('change', async(ev)=>{ if(syncingToggle) return; try{ if(ev.target.checked) await handleTurnOn(); else await handleTurnOff(); }catch(e){ $('controlStatus').textContent=`실패: ${e.message}`; await tick(); } });


async function handleExchangeToggleChange(){
  if(syncingExchangeToggle) return;
  const next={ upbit:$('upbitToggle').checked, bithumb:$('bithumbToggle').checked };
  if(!next.upbit && !next.bithumb){
    $('exchangeToggleStatus').textContent='실패: 최소 1개 거래소는 활성화해야 합니다.';
    syncExchangeToggleUI();
    return;
  }
  exchangeToggles=next;
  syncExchangeToggleUI();
  try{
    const out=await postExchangeToggles({ mode:selectedMode, upbitEnabled:next.upbit, bithumbEnabled:next.bithumb });
    const route=out?.backendRoute?` (${out.backendRoute})`:'';
    $('exchangeToggleStatus').textContent=`적용됨: Upbit=${next.upbit?'활성':'비활성'}, Bithumb=${next.bithumb?'활성':'비활성'}${route}`;
  }catch(e){
    $('exchangeToggleStatus').textContent=`실패: ${e.message}`;
  }
}
$('upbitToggle').addEventListener('change', handleExchangeToggleChange);
$('bithumbToggle').addEventListener('change', handleExchangeToggleChange);
const panicSlider=$('panicSlider'), panicValue=$('panicValue'), panicStatus=$('panicStatus'), panicHoldBtn=$('panicHoldBtn'); let holdTimer=null, holdStart=0;
panicSlider.addEventListener('input',()=>{panicValue.textContent=panicSlider.value;});
panicHoldBtn.addEventListener('mousedown',()=>{ if(Number(panicSlider.value)<100){panicStatus.textContent='실패: 슬라이더를 100으로 올리세요'; return;} holdStart=Date.now(); panicStatus.textContent='홀드 중...'; holdTimer=setTimeout(async()=>{ try{const out=await postControl('panic',{armed:true,holdMs:Date.now()-holdStart,slider:Number(panicSlider.value)}); panicStatus.textContent=`PANIC 실행됨 (${out?.result?.status||'ok'})`; await tick();}catch(e){panicStatus.textContent=`실패: ${e.message}`;} },2000);});
['mouseup','mouseleave'].forEach((ev)=> panicHoldBtn.addEventListener(ev,()=>{ if(holdTimer){clearTimeout(holdTimer); holdTimer=null; if(Date.now()-holdStart<2000) panicStatus.textContent='취소됨: 2초 이상 홀드 필요'; }}));

$('orderCancelBtn').addEventListener('click', async()=>{ const orderId=String($('orderIdInput').value||'').trim(); if(!orderId){$('orderStatus').textContent='실패: orderId 입력 필요';return;} try{const out=await postControl('cancel-order',{orderId}); $('orderStatus').textContent=`취소 요청 성공: ${out?.result?.orderId||orderId}`; await tick();}catch(e){$('orderStatus').textContent=`실패: ${e.message}`;} });

function setManualRefreshState(){ const btn=$('refreshConnBtn'), label=$('refreshConnState'); btn.disabled=manualRefreshBusy; btn.innerHTML=manualRefreshBusy?'<span class="spinner"></span> 새로고침 중...':'연결 상태 새로고침'; const t=lastManualRefreshAt?new Date(lastManualRefreshAt).toLocaleTimeString():'-'; label.textContent=lastManualRefreshError?`수동 갱신 실패: ${lastManualRefreshError}`:`수동 갱신: ${t}`; }
$('refreshConnBtn').addEventListener('click', async()=>{ if(manualRefreshBusy) return; manualRefreshBusy=true; setManualRefreshState(); try{ const [workerPayload, overview] = await Promise.all([fetchJson('/api/worker'), fetchJson(overviewUrl())]); const worker = normalizeWorkerPayload(workerPayload); if(worker) overview.worker=worker; render(overview); lastManualRefreshAt=Date.now(); lastManualRefreshError=''; }catch(e){ lastManualRefreshError=e.message; } finally { manualRefreshBusy=false; setManualRefreshState(); }});

async function tick(){ try{ render(await fetchJson(overviewUrl())); }catch(e){ $('ts').textContent='fetch failed: '+e.message; } }
setModeButtons(); setManualRefreshState(); tick(); setInterval(tick, 1000);
</script>
</body>
</html>