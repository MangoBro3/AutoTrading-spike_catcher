<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Team Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0f1115;color:#e9edf1;margin:0;padding:16px}
    h1{margin:0 0 12px;font-size:20px}
    .muted{color:#9aa4b2;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .card{background:#161a22;border:1px solid #252b36;border-radius:10px;padding:12px}
    .ok{color:#47d16c}.warn{color:#ffca5f}.bad{color:#ff6b6b}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px;border-bottom:1px solid #262d38;text-align:left}
    code{background:#1f2530;padding:1px 5px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Agent Team Dashboard</h1>
  <div class="muted" id="ts">loading...</div>
  <div class="grid" style="margin-top:12px">
    <div class="card"><h3>Gateway</h3><div id="gateway"></div></div>
    <div class="card"><h3>Channels</h3><div id="channels"></div></div>
    <div class="card"><h3>Checkpoint</h3><div id="checkpoint"></div></div>
  </div>
  <div class="card" style="margin-top:12px">
    <h3>Agents</h3>
    <table id="agentsTbl"><thead><tr><th>ID</th><th>Workspace</th><th>Model</th><th>Bindings</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="card" style="margin-top:12px">
    <h3>Sessions</h3>
    <div id="sessions"></div>
  </div>
<script>
const $ = (id)=>document.getElementById(id);
function esc(s){return String(s??'').replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]))}

function render(data){
  $('ts').textContent = `updated: ${new Date(data.now).toLocaleString()}`;
  $('gateway').innerHTML = `<div><b>target</b>: <code>${esc(data.gateway?.target||'-')}</code></div>
  <div><b>mode</b>: ${esc(data.gateway?.mode||'-')}</div>`;

  const ch = data.channelSummary?.channels || [];
  $('channels').innerHTML = ch.map(c=>`<div>${esc(c.channel)}: <b class="${c.state==='OK'?'ok':'warn'}">${esc(c.state)}</b> â€” ${esc(c.detail||'')}</div>`).join('') || 'no channels';

  const ck = data.checkpoint;
  $('checkpoint').innerHTML = ck ? `<div>Status: <b>${esc(ck.status)}</b></div>
    <div>Fail: ${esc(ck.fail_count)}</div>
    <div>Step: ${esc(ck.last_failed_step)}</div>` : '<span class="muted">latest.json not found</span>';

  const tbody = $('agentsTbl').querySelector('tbody');
  tbody.innerHTML = (data.agents||[]).map(a=>`<tr><td>${esc(a.id)}</td><td>${esc(a.workspace)}</td><td>${esc(a.model)}</td><td>${esc(a.bindings)}</td></tr>`).join('');

  const sess = data.sessions?.list || [];
  $('sessions').innerHTML = `<div class="muted">total: ${esc(data.sessions?.total ?? sess.length)}</div>` +
    `<table><thead><tr><th>key</th><th>age</th><th>tokens</th></tr></thead><tbody>`+
    sess.slice(0,15).map(s=>`<tr><td>${esc(s.key)}</td><td>${esc(s.age||s.ageText||'-')}</td><td>${esc(s.tokensText||'-')}</td></tr>`).join('')+
    `</tbody></table>`;
}

async function tick(){
  try{
    const r=await fetch('/api/overview');
    const j=await r.json();
    render(j);
  }catch(e){$('ts').textContent='fetch failed: '+e.message}
}

tick(); setInterval(tick, 10000);
</script>
</body>
</html>